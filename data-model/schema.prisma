generator client {
  provider            = "prisma-client"
  output              = "./src/generated/prisma"
  importFileExtension = "js"
  moduleFormat        = "esm"
}

generator zod {
  provider = "prisma-zod-generator"
  output   = "./src/generated/zod-prisma"
  config   = "./zod-prisma.config.json"
}

datasource db {
  provider = "mysql"
}

/// User model representing a monitor in the system.
model User {
  id               Int               @id @default(autoincrement()) @map("user_id")
  istId            String            @unique() @map("ist_id") @db.VarChar(12)
  name             String            @db.VarChar(255)
  active           Boolean           @default(true)
  admin            Boolean           @default(false)
  color            String            @default("#0076DC") @db.Char(7)
  logHours         LogHour[]
  monitorSchedules MonitorSchedule[]
  roomReservations RoomReservation[]
  roomEvents       RoomEvent[]
  monitorTargets   MonitorTarget[]
  printTasks       PrintTask[]

  @@map("users")
}

model Student {
  id           Int      @id @default(autoincrement())
  istId        String   @unique() @map("ist_id") @db.VarChar(12)
  name         String   @db.VarChar(255)
  email        String   @db.Text
  mifareNumber Int      @unique @map("mifare_number")
  lastRenewed  DateTime @default(now()) @map("last_renewed") @db.Date
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  @@map("students")
}

enum WorkstationStatus {
  ACTIVE
  DISABLED
  REMOTE
}

model Workstation {
  id         Int               @id @default(autoincrement())
  name       String            @unique() @db.VarChar(255)
  capacity   Int               @default(0)
  occupation Int               @default(0)
  type       WorkstationStatus @map("type")
  softwares  String            @default("[]") @map("software") @db.LongText
  problems   String            @default("[]") @db.LongText
  entries    Entry[]

  @@map("workstations")
}

model Entry {
  id            Int         @id @default(autoincrement())
  workstationId Int         @map("workstation_id")
  istId         String      @map("ist_id") @db.VarChar(12)
  createdAt     DateTime    @default(now()) @map("created_at") @db.Timestamp(0)
  closedAt      DateTime?   @map("closed_at") @db.Time(0)
  active        Boolean     @default(true)
  observations  String?     @default("") @db.Text
  workstation   Workstation @relation(fields: [workstationId], references: [id], onUpdate: Restrict)

  @@index([workstationId])
  @@map("entries")
}

model LogHour {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  entry       DateTime @db.DateTime(0)
  exit        DateTime @db.DateTime(0)
  time        Int
  entryNumber Int      @map("entry_number")
  exitNumber  Int      @map("exit_number")
  safeAmount  Int      @map("safe_amount")
  user        User     @relation(fields: [userId], references: [id], onUpdate: Restrict)

  @@index([userId])
  @@map("log_hours")
}

model MonitorSchedule {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  entry     DateTime @db.DateTime(0)
  exit      DateTime @db.DateTime(0)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(0)
  user      User     @relation(fields: [userId], references: [id], onUpdate: Restrict)

  @@index([userId])
  @@map("monitor_schedule")
}

model MonitorTarget {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  dateStart   DateTime @map("date_start") @db.Date
  dateEnd     DateTime @map("date_end") @db.Date
  targetHours Int      @map("target_hours")
  user        User     @relation(fields: [userId], references: [id], onUpdate: Restrict)

  @@map("monitor_targets")
}

model OffDay {
  id   Int       @id @default(autoincrement())
  date DateTime? @db.Date

  @@map("off_days")
}

model Publication {
  id        Int      @id @default(autoincrement())
  title     String   @db.VarChar(255)
  text      String   @db.Text
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(0)
  active    Boolean  @default(true)

  @@map("publications")
}

enum RoomEventType {
  RES_CREATED
  RES_UPDATED
  RES_DELETED
  KEY_GIVEN
  KEY_RECEIVED
}

model RoomEvent {
  id                Int             @id @default(autoincrement())
  type              RoomEventType
  userId            Int             @map("user_id")
  roomReservationId Int             @map("room_data_id")
  observations      String?         @default("") @db.Text
  createdAt         DateTime        @default(now()) @map("created_at") @db.Timestamp(0)
  user              User            @relation(fields: [userId], references: [id], onUpdate: Restrict)
  roomReservation   RoomReservation @relation(fields: [roomReservationId], references: [id], onUpdate: Restrict)

  @@map("room_events")
}

model RoomReservation {
  id        Int         @id @default(autoincrement())
  userId    Int         @map("user_id")
  entry     DateTime    @db.DateTime(0)
  exit      DateTime    @db.DateTime(0)
  room      String      @db.VarChar(255)
  name      String      @map("reservation_name") @db.VarChar(255)
  istId     String      @map("reservation_id")
  givenKey  Boolean     @default(false) @map("given_key")
  user      User        @relation(fields: [userId], references: [id], onUpdate: Restrict)
  deleted   Boolean     @default(false)
  RoomEvent RoomEvent[]

  @@index([userId])
  @@map("room_hours")
}

/**
 * Printing
 */

enum Unit {
  MILIMETERS
  CENTIMETERS
  METERS
}

enum PrintTaskStatus {
  WAITING
  PENDING
  IN_QUEUE
  PRINTING
  COMPLETED
  DELIVERED
  CANCELLED
}

model PrintTask {
  id           Int             @id @default(autoincrement())
  name         String          @db.VarChar(255)
  modelFiles   Json            @map("model_files")
  materialId   Int             @map("material_id")
  material     PrintMaterial   @relation(fields: [materialId], references: [id], onUpdate: Restrict)
  status       PrintTaskStatus @default(WAITING)
  amount       Int             @default(1)
  studentName  String          @map("student_name") @db.VarChar(255)
  studentId    String          @map("student_id") @db.VarChar(12)
  email        String          @db.VarChar(255)
  unit         Unit
  price        Float
  deadline     DateTime?       @db.Date
  observations String          @default("") @db.Text
  assignedId   Int?            @map("assigned_id")
  assigned     User?           @relation(fields: [assignedId], references: [id], onUpdate: Restrict)
  createdAt    DateTime        @default(now()) @map("created_at") @db.Timestamp(0)
  completedAt  DateTime?       @map("completed_at") @db.Timestamp(0)

  @@map("print_tasks")
}

model PrintMaterial {
  id              Int         @id @default(autoincrement())
  name            String      @db.VarChar(255)
  description     String      @db.Text
  priceMultiplier Float       @map("price_multiplier")
  active          Boolean     @default(true)
  PrintTask       PrintTask[]

  @@map("print_materials")
}
